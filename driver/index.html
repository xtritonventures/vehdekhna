<!DOCTYPE html>
<html>
<head>
  <title>Driver Tracking Panel</title>

  <style>
    body {
      background-color: #0f2a1f;
      color: #ffffff;
      font-family: Arial, sans-serif;
      text-align: center;
    }

    h2 {
      margin-top: 40px;
    }

    input, select, button {
      padding: 10px;
      margin: 8px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
    }

    button {
      background-color: #4caf50;
      color: #000000;
      font-weight: bold;
      cursor: pointer;
    }

    .status-box {
      background-color: #163c2d;
      border: 2px solid #4caf50;
      border-radius: 8px;
      padding: 25px;
      width: 85%;
      max-width: 440px;
      margin: 40px auto;
      font-size: 18px;
      line-height: 1.6;
    }

    .highlight {
      color: #4caf50;
      font-weight: bold;
    }

    .warning {
      margin-top: 18px;
      color: #ffcc00;
      font-weight: bold;
    }

    .live-status {
      margin-top: 15px;
      font-size: 16px;
      font-weight: bold;
      color: #9cffc2;
    }
  </style>
</head>

<body>

  <!-- INPUT SCREEN -->
  <div id="inputScreen">
    <h2>Driver Location Panel</h2>

    <div>
      <div>Vehicle ID</div>
      <input id="busId" placeholder="Enter Vehicle ID">
    </div>

    <div>
      <div>Group</div>
      <select id="group">
      <option>43</option>
      <option>75</option>
      <option>18</option>
      <option>24</option>
      <option>692</option>
      <option>964</option>
      <option>204</option>
      </select>
    </div>

    <button onclick="startTracking()">Start Tracking</button>
  </div>

  <!-- STATUS SCREEN -->
  <div id="statusScreen" style="display:none;">
    <div class="status-box">
      YOUR LOCATION IS NOW BEING SHARED AS<br>
      <span class="highlight" id="statusBus"></span><br>
      UNDER <span class="highlight" id="statusGroup"></span>

      <div class="warning">
        PLEASE KEEP THIS BROWSER TAB OPEN
      </div>

      <div class="live-status" id="liveStatus">
        Initialising GPSâ€¦
      </div>
    </div>
  </div>

  <script>
    let busId, group;
    let watchId = null;
    let retryTimer = null;

    /* ðŸ”Š Beep on start */
    function beep() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.frequency.value = 900;
      gain.gain.value = 0.2;

      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.start();
      setTimeout(() => {
        osc.stop();
        ctx.close();
      }, 200);
    }

    function setStatus(text) {
      document.getElementById("liveStatus").innerText = text;
    }

    function startTracking() {
      busId = document.getElementById("busId").value.trim();
      group = document.getElementById("group").value;

      if (!busId) {
        alert("Please enter Vehicle ID");
        return;
      }

      document.getElementById("inputScreen").style.display = "none";
      document.getElementById("statusScreen").style.display = "block";

      document.getElementById("statusBus").innerText = busId;
      document.getElementById("statusGroup").innerText = group;

      beep();
      setStatus("Requesting GPS permissionâ€¦");

      startLocationWatch();
    }

    function startLocationWatch() {
      if (!navigator.geolocation) {
        setStatus("âŒ GPS not supported on this device");
        return;
      }

      setStatus("ðŸ“¡ GPS active â€“ waiting for locationâ€¦");

      watchId = navigator.geolocation.watchPosition(
        position => {
          sendLocation(position.coords.latitude, position.coords.longitude);
          setStatus(
            `âœ… Location sent at ${new Date().toLocaleTimeString()}`
          );
        },
        error => {
          handleLocationError(error);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 10000
        }
      );
    }

    function handleLocationError(error) {
      setStatus("âš ï¸ GPS lost â€“ retrying in 5 secondsâ€¦");

      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      if (!retryTimer) {
        retryTimer = setTimeout(() => {
          retryTimer = null;
          setStatus("ðŸ”„ Reconnecting to GPSâ€¦");
          startLocationWatch();
        }, 5000);
      }
    }

    function sendLocation(lat, lon) {
      fetch('/update-location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          busId: busId,
          group: group,
          latitude: lat,
          longitude: lon
        })
      });
    }
  </script>

</body>
</html>
